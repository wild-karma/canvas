<!DOCTYPE html>
<html>
    <head>
        <title>Wild Karma</title>
        <script>
        window.fbAsyncInit = function() {
            FB.init({
                appId: '1619998651574970',
                status: true, // get info about user immediately after init
                xfbml: false, // no FBML social plugins, decrease load time
                version: 'v2.3'
            });

            function onLogin(response) {
                if (response.status == 'connected') {
                    FB.api('/me?fields=first_name', function(data) {
                        var welcomeBlock = document.getElementById('fb-welcome');
                        welcomeBlock.innerHTML = 'Hello, ' + data.first_name + '!';
                        
                        renderMFS();
                    });
                }
            }

            FB.getLoginStatus(function(response) {
                // Check login status on load, and if the user is
                // already logged in, go directly to the welcome message.
                if (response.status == 'connected') {
                    onLogin(response);
                } else {
                    // Otherwise, show Login dialog first.
                    FB.login(function(response) {
                        onLogin(response);
                    }, {scope: 'user_friends'});
                    // https://developers.facebook.com/docs/facebook-login/permissions/v2.3#reference-user_friends
                }
            });

            function renderMFS() {
             // First get the list of friends for this user with the Graph API
             FB.api('/me/taggable_friends', function(response) {
                 var container = document.getElementById('mfs');
                 var mfsForm = document.createElement('form');
                 mfsForm.id = 'mfsForm';

                 // Iterate through the array of friends object and create a checkbox for each one.
                for(var i = 0; i < Math.min(response.data.length, 10); i++) {
                    var friendItem = document.createElement('div');
                    friendItem.id = 'friend_' + response.data[i].id;
                    friendItem.innerHTML = '<input type="checkbox" name="friends" value="'
                        + response.data[i].id
                        + '" />' + response.data[i].name;
                     mfsForm.appendChild(friendItem);
                }
                container.appendChild(mfsForm);

                 // Create a button to send the Request(s)
                 var sendButton = document.createElement('input');
                 sendButton.type = 'button';
                 sendButton.value = 'Send Request';
                 sendButton.onclick = sendRequest;
                 mfsForm.appendChild(sendButton);
            });

            function sendRequest() {
                // Get the list of selected friends
                var sendUIDs = '';
                var mfsForm = document.getElementById('mfsForm');
                  for(var i = 0; i < mfsForm.friends.length; i++) {
                    if(mfsForm.friends[i].checked) {
                      sendUIDs += mfsForm.friends[i].value + ',';
                    }
                  }

                // Use FB.ui to send the Request(s)
                // TODO You cannot send app requests for non-game apps. This appears to be the only way for now.
                FB.ui({method: 'send',
                  to: sendUIDs,
                  link: 'https://google.com',
                  title: 'Check This Person Out!',
                }, callback);
              }

              function callback(response) {
                console.log(response);
              }

            }
        };

        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            // Used for local dev.
            //js.src = "https://connect.facebook.net/en_US/sdk/debug.js";
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
        </script>
    </head>
    <body>
        <h1 id="fb-welcome"></h1>
        <div id="mfs"></div>
    </body>
</html>
